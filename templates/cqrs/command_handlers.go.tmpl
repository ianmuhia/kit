package cqrs

import (
	"context"
	"fmt"
	"log/slog"
	"time"

	{{.DomainLower}} "ibnb/internal/{{.DomainLower}}"
	"github.com/ThreeDotsLabs/watermill/components/cqrs"
)

// Create{{.DomainTitle}}Handler handles Create{{.DomainTitle}}Command
type Create{{.DomainTitle}}Handler struct {
	repo     {{.DomainLower}}.Repository
	eventBus *cqrs.EventBus
}

// NewCreate{{.DomainTitle}}Handler creates a new command handler
func NewCreate{{.DomainTitle}}Handler(repo {{.DomainLower}}.Repository, eventBus *cqrs.EventBus) *Create{{.DomainTitle}}Handler {
	return &Create{{.DomainTitle}}Handler{
		repo:     repo,
		eventBus: eventBus,
	}
}

// Handle processes the Create{{.DomainTitle}}Command
func (h *Create{{.DomainTitle}}Handler) Handle(ctx context.Context, cmd *Create{{.DomainTitle}}Command) error {
	entity := &{{.DomainLower}}.{{.DomainTitle}}{
		Name:        cmd.Name,
		Description: cmd.Description,
		Active:      cmd.Active,
		CreatedBy:   cmd.CreatedBy,
		CreatedAt:   time.Now(),
		UpdatedAt:   time.Now(),
	}

	if err := entity.Validate(); err != nil {
		return fmt.Errorf("validation failed: %w", err)
	}

	if err := h.repo.Create(ctx, entity); err != nil {
		return fmt.Errorf("failed to create {{.DomainLower}}: %w", err)
	}

	slog.Info("{{.DomainTitle}} created",
		"{{.DomainLower}}_id", entity.ID,
		"name", entity.Name,
		"created_by", entity.CreatedBy,
	)

	// Publish domain event
	event := &{{.DomainTitle}}CreatedEvent{
		{{.DomainTitle}}ID: entity.ID,
		Name:       entity.Name,
		CreatedBy:  entity.CreatedBy,
		OccurredAt: time.Now(),
	}

	if err := h.eventBus.Publish(ctx, event); err != nil {
		slog.Error("Failed to publish {{.DomainTitle}}CreatedEvent", "error", err)
		// Don't return error - event publishing failure shouldn't rollback the command
	}

	return nil
}

// Update{{.DomainTitle}}Handler handles Update{{.DomainTitle}}Command
type Update{{.DomainTitle}}Handler struct {
	repo     {{.DomainLower}}.Repository
	eventBus *cqrs.EventBus
}

// NewUpdate{{.DomainTitle}}Handler creates a new command handler
func NewUpdate{{.DomainTitle}}Handler(repo {{.DomainLower}}.Repository, eventBus *cqrs.EventBus) *Update{{.DomainTitle}}Handler {
	return &Update{{.DomainTitle}}Handler{
		repo:     repo,
		eventBus: eventBus,
	}
}

// Handle processes the Update{{.DomainTitle}}Command
func (h *Update{{.DomainTitle}}Handler) Handle(ctx context.Context, cmd *Update{{.DomainTitle}}Command) error {
	entity, err := h.repo.GetByID(ctx, cmd.{{.DomainTitle}}ID)
	if err != nil {
		return fmt.Errorf("failed to get {{.DomainLower}}: %w", err)
	}

	if err := entity.CanBeModified(); err != nil {
		return fmt.Errorf("{{.DomainLower}} cannot be modified: %w", err)
	}

	entity.Name = cmd.Name
	entity.Description = cmd.Description
	entity.UpdatedBy = cmd.UpdatedBy
	entity.UpdatedAt = time.Now()

	if err := entity.Validate(); err != nil {
		return fmt.Errorf("validation failed: %w", err)
	}

	if err := h.repo.Update(ctx, entity); err != nil {
		return fmt.Errorf("failed to update {{.DomainLower}}: %w", err)
	}

	slog.Info("{{.DomainTitle}} updated",
		"{{.DomainLower}}_id", entity.ID,
		"updated_by", entity.UpdatedBy,
	)

	// Publish domain event
	event := &{{.DomainTitle}}UpdatedEvent{
		{{.DomainTitle}}ID: entity.ID,
		UpdatedBy:  entity.UpdatedBy,
		OccurredAt: time.Now(),
	}

	if err := h.eventBus.Publish(ctx, event); err != nil {
		slog.Error("Failed to publish {{.DomainTitle}}UpdatedEvent", "error", err)
	}

	return nil
}

// Delete{{.DomainTitle}}Handler handles Delete{{.DomainTitle}}Command
type Delete{{.DomainTitle}}Handler struct {
	repo     {{.DomainLower}}.Repository
	eventBus *cqrs.EventBus
}

// NewDelete{{.DomainTitle}}Handler creates a new command handler
func NewDelete{{.DomainTitle}}Handler(repo {{.DomainLower}}.Repository, eventBus *cqrs.EventBus) *Delete{{.DomainTitle}}Handler {
	return &Delete{{.DomainTitle}}Handler{
		repo:     repo,
		eventBus: eventBus,
	}
}

// Handle processes the Delete{{.DomainTitle}}Command
func (h *Delete{{.DomainTitle}}Handler) Handle(ctx context.Context, cmd *Delete{{.DomainTitle}}Command) error {
	if err := h.repo.Delete(ctx, cmd.{{.DomainTitle}}ID); err != nil {
		return fmt.Errorf("failed to delete {{.DomainLower}}: %w", err)
	}

	slog.Info("{{.DomainTitle}} deleted",
		"{{.DomainLower}}_id", cmd.{{.DomainTitle}}ID,
		"deleted_by", cmd.DeletedBy,
		"reason", cmd.Reason,
	)

	// Publish domain event
	event := &{{.DomainTitle}}DeletedEvent{
		{{.DomainTitle}}ID: cmd.{{.DomainTitle}}ID,
		DeletedBy:  cmd.DeletedBy,
		OccurredAt: time.Now(),
	}

	if err := h.eventBus.Publish(ctx, event); err != nil {
		slog.Error("Failed to publish {{.DomainTitle}}DeletedEvent", "error", err)
	}

	return nil
}
