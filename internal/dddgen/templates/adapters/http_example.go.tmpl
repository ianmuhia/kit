package main

import (
	"context"
	"fmt"
	"log"
	"log/slog"
	"net/http"
	"os"
	"time"

	"github.com/danielgtaylor/huma/v2"
	"github.com/danielgtaylor/huma/v2/adapters/humachi"
	"github.com/go-chi/chi/v5"
	"github.com/go-chi/chi/v5/middleware"

	// Import your generated domain packages
	"{{.DomainLower}}/internal/{{.DomainLower}}/adapters"
	"{{.DomainLower}}/internal/{{.DomainLower}}/app"
)

// Example of how to wire up your {{.DomainLower}} API with Huma and Chi
// with middleware configured at the root level
func main() {
	// Setup structured logging
	logger := slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{
		Level: slog.LevelInfo,
	}))
	slog.SetDefault(logger)

	// Create Chi router
	router := chi.NewMux()

	// Configure middleware at the root level (applies to all routes)
	router.Use(middleware.RequestID)
	router.Use(middleware.RealIP)
	router.Use(middleware.Logger)
	router.Use(middleware.Recoverer)
	router.Use(middleware.Compress(5))
	
	// Optional: Add CORS middleware
	router.Use(corsMiddleware([]string{"https://yourdomain.com"}))
	
	// Optional: Add timeout middleware
	router.Use(middleware.Timeout(30 * time.Second))

	// Create Huma API with Chi adapter
	config := huma.DefaultConfig("{{.DomainTitle}} API", "1.0.0")
	config.Info.Description = "Production-ready API for {{.DomainLower}} management"
	config.Servers = []*huma.Server{
		{URL: "http://localhost:8080", Description: "Local server"},
	}
	
	humaAPI := humachi.New(router, config)

	// Initialize your service layer
	// NOTE: Replace these with your actual implementations
	// db := connectDatabase()
	// repo := adapters.NewPostgres{{.DomainTitle}}Repository(db)
	// service := app.NewService(repo)
	var service *app.Service // TODO: Initialize with real dependencies

	// Create and register {{.DomainLower}} API
	{{.DomainLower}}API := adapters.New{{.DomainTitle}}API(
		service,
		adapters.WithLogger(logger),
	)
	{{.DomainLower}}API.Register(humaAPI)
	{{.DomainLower}}API.RegisterHealthCheck(humaAPI)

	// Start server
	port := 8080
	logger.Info("starting server", slog.Int("port", port))
	fmt.Printf("OpenAPI docs: http://localhost:%d/docs\n", port)
	fmt.Printf("OpenAPI spec: http://localhost:%d/openapi.json\n", port)
	
	if err := http.ListenAndServe(fmt.Sprintf(":%d", port), router); err != nil {
		log.Fatal(err)
	}
}

// corsMiddleware is a simple CORS middleware example
// In production, consider using github.com/rs/cors
func corsMiddleware(allowedOrigins []string) func(http.Handler) http.Handler {
	return func(next http.Handler) http.Handler {
		return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			origin := r.Header.Get("Origin")
			
			// Check if origin is allowed
			allowed := false
			if len(allowedOrigins) == 0 {
				allowed = true
			} else {
				for _, allowedOrigin := range allowedOrigins {
					if origin == allowedOrigin || allowedOrigin == "*" {
						allowed = true
						break
					}
				}
			}

			if allowed && origin != "" {
				w.Header().Set("Access-Control-Allow-Origin", origin)
				w.Header().Set("Access-Control-Allow-Methods", "GET, POST, PUT, PATCH, DELETE, OPTIONS")
				w.Header().Set("Access-Control-Allow-Headers", "Accept, Authorization, Content-Type, X-Request-ID")
				w.Header().Set("Access-Control-Allow-Credentials", "true")
				w.Header().Set("Access-Control-Max-Age", "86400")
			}

			// Handle preflight
			if r.Method == http.MethodOptions {
				w.WriteHeader(http.StatusNoContent)
				return
			}

			next.ServeHTTP(w, r)
		})
	}
}

// Example with API versioning and route groups:
func exampleWithVersioning() {
	router := chi.NewMux()
	
	// Root level middleware
	router.Use(middleware.RequestID)
	router.Use(middleware.Logger)
	router.Use(middleware.Recoverer)

	// Create v1 API group
	router.Route("/api/v1", func(r chi.Router) {
		config := huma.DefaultConfig("{{.DomainTitle}} API", "1.0.0")
		api := humachi.New(r, config)
		
		// Register operations
		var service *app.Service // TODO: Initialize
		{{.DomainLower}}API := adapters.New{{.DomainTitle}}API(service)
		{{.DomainLower}}API.RegisterWithPrefix(api, "") // Empty prefix since we're already in /api/v1
	})

	// Create v2 API group (future)
	router.Route("/api/v2", func(r chi.Router) {
		config := huma.DefaultConfig("{{.DomainTitle}} API", "2.0.0")
		api := humachi.New(r, config)
		// Register v2 operations
	})

	http.ListenAndServe(":8080", router)
}

// Example with custom authentication middleware:
func exampleWithAuth() {
	router := chi.NewMux()
	
	// Public routes (no auth required)
	router.Group(func(r chi.Router) {
		config := huma.DefaultConfig("{{.DomainTitle}} API", "1.0.0")
		api := humachi.New(r, config)
		
		var service *app.Service
		{{.DomainLower}}API := adapters.New{{.DomainTitle}}API(service)
		{{.DomainLower}}API.RegisterHealthCheck(api)
	})
	
	// Protected routes (auth required)
	router.Group(func(r chi.Router) {
		// Add authentication middleware to this group
		r.Use(authMiddleware)
		
		config := huma.DefaultConfig("{{.DomainTitle}} API", "1.0.0")
		api := humachi.New(r, config)
		
		var service *app.Service
		{{.DomainLower}}API := adapters.New{{.DomainTitle}}API(service)
		{{.DomainLower}}API.Register(api)
	})

	http.ListenAndServe(":8080", router)
}

// authMiddleware is an example authentication middleware
func authMiddleware(next http.Handler) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		// Get token from Authorization header
		token := r.Header.Get("Authorization")
		if token == "" {
			http.Error(w, "Unauthorized", http.StatusUnauthorized)
			return
		}

		// Validate token (implement your auth logic here)
		// userID, err := validateToken(token)
		// if err != nil {
		// 	http.Error(w, "Invalid token", http.StatusUnauthorized)
		// 	return
		// }

		// Add user info to context
		ctx := context.WithValue(r.Context(), "user_id", 123)
		next.ServeHTTP(w, r.WithContext(ctx))
	})
}

// Example with rate limiting using github.com/mennanov/limiters
func exampleWithRateLimiting() {
	router := chi.NewMux()
	
	// Standard middleware
	router.Use(middleware.RequestID)
	router.Use(middleware.Logger)
	router.Use(middleware.Recoverer)
	
	// Rate limiting middleware (basic example)
	// For production, use Redis-backed rate limiting
	router.Use(middleware.ThrottleBacklog(100, 1000, 10*time.Second))

	config := huma.DefaultConfig("{{.DomainTitle}} API", "1.0.0")
	api := humachi.New(router, config)
	
	var service *app.Service
	{{.DomainLower}}API := adapters.New{{.DomainTitle}}API(service)
	{{.DomainLower}}API.Register(api)

	http.ListenAndServe(":8080", router)
}
