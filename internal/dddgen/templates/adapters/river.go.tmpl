package adapters

import (
	"context"
	"encoding/json"
	"fmt"

	{{.DomainLower}} "ibnb/internal/{{.DomainLower}}"

	"github.com/riverqueue/river"
)

// {{.DomainTitle}}CreatedJobArgs represents job args for {{.DomainLower}} creation events
type {{.DomainTitle}}CreatedJobArgs struct {
	{{.DomainTitle}}ID int       `json:"{{.DomainLower}}_id"`
	Name       string    `json:"name"`
	CreatedBy  int       `json:"created_by"`
	Metadata   map[string]interface{} `json:"metadata,omitempty"`
}

func ({{.DomainTitle}}CreatedJobArgs) Kind() string { return "{{.DomainLower}}_created" }

// {{.DomainTitle}}UpdatedJobArgs represents job args for {{.DomainLower}} update events
type {{.DomainTitle}}UpdatedJobArgs struct {
	{{.DomainTitle}}ID int       `json:"{{.DomainLower}}_id"`
	Changes    map[string]interface{} `json:"changes"`
	UpdatedBy  int       `json:"updated_by"`
}

func ({{.DomainTitle}}UpdatedJobArgs) Kind() string { return "{{.DomainLower}}_updated" }

// {{.DomainTitle}}DeletedJobArgs represents job args for {{.DomainLower}} deletion events
type {{.DomainTitle}}DeletedJobArgs struct {
	{{.DomainTitle}}ID int    `json:"{{.DomainLower}}_id"`
	DeletedBy  int    `json:"deleted_by"`
	Reason     string `json:"reason,omitempty"`
}

func ({{.DomainTitle}}DeletedJobArgs) Kind() string { return "{{.DomainLower}}_deleted" }

// {{.DomainTitle}}CreatedWorker handles {{.DomainLower}} created jobs
type {{.DomainTitle}}CreatedWorker struct {
	river.WorkerDefaults[{{.DomainTitle}}CreatedJobArgs]
	// Add dependencies like services, repositories, etc.
}

// Work processes a {{.DomainLower}} created job
func (w *{{.DomainTitle}}CreatedWorker) Work(ctx context.Context, job *river.Job[{{.DomainTitle}}CreatedJobArgs]) error {
	// TODO: Implement your business logic here
	// Examples:
	// - Send notification emails
	// - Update search index
	// - Trigger downstream workflows
	// - Update analytics/metrics
	
	fmt.Printf("Processing {{.DomainLower}} created: ID=%d, Name=%s\n", 
		job.Args.{{.DomainTitle}}ID, job.Args.Name)
	
	return nil
}

// {{.DomainTitle}}UpdatedWorker handles {{.DomainLower}} updated jobs
type {{.DomainTitle}}UpdatedWorker struct {
	river.WorkerDefaults[{{.DomainTitle}}UpdatedJobArgs]
	// Add dependencies
}

// Work processes a {{.DomainLower}} updated job
func (w *{{.DomainTitle}}UpdatedWorker) Work(ctx context.Context, job *river.Job[{{.DomainTitle}}UpdatedJobArgs]) error {
	// TODO: Implement your business logic here
	// Examples:
	// - Sync changes to cache
	// - Update search index
	// - Send update notifications
	// - Trigger change validation workflows
	
	fmt.Printf("Processing {{.DomainLower}} updated: ID=%d, Changes=%+v\n", 
		job.Args.{{.DomainTitle}}ID, job.Args.Changes)
	
	return nil
}

// {{.DomainTitle}}DeletedWorker handles {{.DomainLower}} deleted jobs
type {{.DomainTitle}}DeletedWorker struct {
	river.WorkerDefaults[{{.DomainTitle}}DeletedJobArgs]
	// Add dependencies
}

// Work processes a {{.DomainLower}} deleted job
func (w *{{.DomainTitle}}DeletedWorker) Work(ctx context.Context, job *river.Job[{{.DomainTitle}}DeletedJobArgs]) error {
	// TODO: Implement your business logic here
	// Examples:
	// - Clean up related resources
	// - Archive data
	// - Send deletion notifications
	// - Update analytics
	
	fmt.Printf("Processing {{.DomainLower}} deleted: ID=%d, Reason=%s\n", 
		job.Args.{{.DomainTitle}}ID, job.Args.Reason)
	
	return nil
}

// {{.DomainTitle}}RiverClient wraps River client for {{.DomainLower}} job operations
type {{.DomainTitle}}RiverClient struct {
	client *river.Client[river.DriverRiverPgxV5]
}

// New{{.DomainTitle}}RiverClient creates a new River client wrapper
func New{{.DomainTitle}}RiverClient(client *river.Client[river.DriverRiverPgxV5]) *{{.DomainTitle}}RiverClient {
	return &{{.DomainTitle}}RiverClient{
		client: client,
	}
}

// Enqueue{{.DomainTitle}}Created enqueues a {{.DomainLower}} created job
func (c *{{.DomainTitle}}RiverClient) Enqueue{{.DomainTitle}}Created(ctx context.Context, event {{.DomainLower}}.{{.DomainTitle}}CreatedEvent) error {
	args := {{.DomainTitle}}CreatedJobArgs{
		{{.DomainTitle}}ID: event.{{.DomainTitle}}ID,
		Name:       event.Name,
		CreatedBy:  event.CreatedBy,
	}
	
	_, err := c.client.Insert(ctx, args, nil)
	if err != nil {
		return fmt.Errorf("failed to enqueue {{.DomainLower}} created job: %w", err)
	}
	
	return nil
}

// Enqueue{{.DomainTitle}}Updated enqueues a {{.DomainLower}} updated job
func (c *{{.DomainTitle}}RiverClient) Enqueue{{.DomainTitle}}Updated(ctx context.Context, event {{.DomainLower}}.{{.DomainTitle}}UpdatedEvent) error {
	args := {{.DomainTitle}}UpdatedJobArgs{
		{{.DomainTitle}}ID: event.{{.DomainTitle}}ID,
		UpdatedBy:  event.UpdatedBy,
		Changes:    make(map[string]interface{}),
	}
	
	// Marshal the full event as changes for simplicity
	changesBytes, _ := json.Marshal(event)
	json.Unmarshal(changesBytes, &args.Changes)
	
	_, err := c.client.Insert(ctx, args, nil)
	if err != nil {
		return fmt.Errorf("failed to enqueue {{.DomainLower}} updated job: %w", err)
	}
	
	return nil
}

// Enqueue{{.DomainTitle}}Deleted enqueues a {{.DomainLower}} deleted job
func (c *{{.DomainTitle}}RiverClient) Enqueue{{.DomainTitle}}Deleted(ctx context.Context, event {{.DomainLower}}.{{.DomainTitle}}DeletedEvent) error {
	args := {{.DomainTitle}}DeletedJobArgs{
		{{.DomainTitle}}ID: event.{{.DomainTitle}}ID,
		DeletedBy:  event.DeletedBy,
	}
	
	_, err := c.client.Insert(ctx, args, nil)
	if err != nil {
		return fmt.Errorf("failed to enqueue {{.DomainLower}} deleted job: %w", err)
	}
	
	return nil
}

// Register{{.DomainTitle}}Workers registers all {{.DomainLower}} workers with River
func Register{{.DomainTitle}}Workers(workers *river.Workers) error {
	// Register all {{.DomainLower}} workers
	if err := river.AddWorkerSafely(workers, &{{.DomainTitle}}CreatedWorker{}); err != nil {
		return fmt.Errorf("failed to register {{.DomainLower}} created worker: %w", err)
	}
	
	if err := river.AddWorkerSafely(workers, &{{.DomainTitle}}UpdatedWorker{}); err != nil {
		return fmt.Errorf("failed to register {{.DomainLower}} updated worker: %w", err)
	}
	
	if err := river.AddWorkerSafely(workers, &{{.DomainTitle}}DeletedWorker{}); err != nil {
		return fmt.Errorf("failed to register {{.DomainLower}} deleted worker: %w", err)
	}
	
	return nil
}

// Example usage:
//
// Initialize River client:
//   dbPool, _ := pgxpool.New(ctx, os.Getenv("DATABASE_URL"))
//   workers := river.NewWorkers()
//   Register{{.DomainTitle}}Workers(workers)
//   
//   riverClient, _ := river.NewClient(riverpgxv5.New(dbPool), &river.Config{
//       Queues: map[string]river.QueueConfig{
//           river.QueueDefault: {MaxWorkers: 100},
//       },
//       Workers: workers,
//   })
//   riverClient.Start(ctx)
//
// Enqueue jobs:
//   {{.DomainLower}}River := New{{.DomainTitle}}RiverClient(riverClient)
//   event := {{.DomainLower}}.{{.DomainTitle}}CreatedEvent{
//       {{.DomainTitle}}ID: 123,
//       Name: "Example",
//       CreatedBy: 1,
//   }
//   {{.DomainLower}}River.Enqueue{{.DomainTitle}}Created(ctx, event)
