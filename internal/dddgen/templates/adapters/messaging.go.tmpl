package adapters

import (
	"context"
	"encoding/json"
	"fmt"

	{{.DomainLower}} "{{.ModulePath}}/internal/{{.DomainLower}}"

	"github.com/ThreeDotsLabs/watermill/message"
)

// {{.DomainTitle}}MessagePublisher publishes {{.DomainLower}} domain events
type {{.DomainTitle}}MessagePublisher struct {
	publisher message.Publisher
}

// New{{.DomainTitle}}MessagePublisher creates a new message publisher
func New{{.DomainTitle}}MessagePublisher(publisher message.Publisher) *{{.DomainTitle}}MessagePublisher {
	return &{{.DomainTitle}}MessagePublisher{
		publisher: publisher,
	}
}

// Publish{{.DomainTitle}}Created publishes a {{.DomainLower}} created event
func (p *{{.DomainTitle}}MessagePublisher) Publish{{.DomainTitle}}Created(ctx context.Context, event {{.DomainLower}}.{{.DomainTitle}}CreatedEvent) error {
	msg, err := event.ToMessage()
	if err != nil {
		return fmt.Errorf("failed to create message: %w", err)
	}

	if err := p.publisher.Publish(string({{.DomainLower}}.Event{{.DomainTitle}}Created), msg); err != nil {
		return fmt.Errorf("failed to publish {{.DomainLower}} created event: %w", err)
	}

	return nil
}

// Publish{{.DomainTitle}}Updated publishes a {{.DomainLower}} updated event
func (p *{{.DomainTitle}}MessagePublisher) Publish{{.DomainTitle}}Updated(ctx context.Context, event {{.DomainLower}}.{{.DomainTitle}}UpdatedEvent) error {
	msg, err := event.ToMessage()
	if err != nil {
		return fmt.Errorf("failed to create message: %w", err)
	}

	if err := p.publisher.Publish(string({{.DomainLower}}.Event{{.DomainTitle}}Updated), msg); err != nil {
		return fmt.Errorf("failed to publish {{.DomainLower}} updated event: %w", err)
	}

	return nil
}

// Publish{{.DomainTitle}}Deleted publishes a {{.DomainLower}} deleted event
func (p *{{.DomainTitle}}MessagePublisher) Publish{{.DomainTitle}}Deleted(ctx context.Context, event {{.DomainLower}}.{{.DomainTitle}}DeletedEvent) error {
	msg, err := event.ToMessage()
	if err != nil {
		return fmt.Errorf("failed to create message: %w", err)
	}

	if err := p.publisher.Publish(string({{.DomainLower}}.Event{{.DomainTitle}}Deleted), msg); err != nil {
		return fmt.Errorf("failed to publish {{.DomainLower}} deleted event: %w", err)
	}

	return nil
}

// {{.DomainTitle}}MessageSubscriber handles {{.DomainLower}} domain events
type {{.DomainTitle}}MessageSubscriber struct {
	// Add dependencies like services, repositories, etc.
}

// New{{.DomainTitle}}MessageSubscriber creates a new message subscriber
func New{{.DomainTitle}}MessageSubscriber() *{{.DomainTitle}}MessageSubscriber {
	return &{{.DomainTitle}}MessageSubscriber{}
}

// Handle{{.DomainTitle}}Created handles {{.DomainLower}} created events
func (s *{{.DomainTitle}}MessageSubscriber) Handle{{.DomainTitle}}Created(msg *message.Message) error {
	var event {{.DomainLower}}.{{.DomainTitle}}CreatedEvent
	if err := json.Unmarshal(msg.Payload, &event); err != nil {
		return fmt.Errorf("failed to unmarshal {{.DomainLower}} created event: %w", err)
	}

	// TODO: Implement your business logic here
	// Examples:
	// - Send notification
	// - Update search index
	// - Trigger workflows
	// - Update analytics
	return nil
}

// Handle{{.DomainTitle}}Updated handles {{.DomainLower}} updated events
func (s *{{.DomainTitle}}MessageSubscriber) Handle{{.DomainTitle}}Updated(msg *message.Message) error {
	var event {{.DomainLower}}.{{.DomainTitle}}UpdatedEvent
	if err := json.Unmarshal(msg.Payload, &event); err != nil {
		return fmt.Errorf("failed to unmarshal {{.DomainLower}} updated event: %w", err)
	}

	// TODO: Implement your business logic here
	return nil
}

// Handle{{.DomainTitle}}Deleted handles {{.DomainLower}} deleted events
func (s *{{.DomainTitle}}MessageSubscriber) Handle{{.DomainTitle}}Deleted(msg *message.Message) error {
	var event {{.DomainLower}}.{{.DomainTitle}}DeletedEvent
	if err := json.Unmarshal(msg.Payload, &event); err != nil {
		return fmt.Errorf("failed to unmarshal {{.DomainLower}} deleted event: %w", err)
	}

	// TODO: Implement your business logic here
	return nil
}

// RegisterHandlers registers all {{.DomainLower}} event handlers
func (s *{{.DomainTitle}}MessageSubscriber) RegisterHandlers(router *message.Router) {
	router.AddConsumerHandler(
		"{{.DomainLower}}_created_handler",
		string({{.DomainLower}}.Event{{.DomainTitle}}Created),
		s.Handle{{.DomainTitle}}Created,
	)

	router.AddConsumerHandler(
		"{{.DomainLower}}_updated_handler",
		string({{.DomainLower}}.Event{{.DomainTitle}}Updated),
		s.Handle{{.DomainTitle}}Updated,
	)

	router.AddConsumerHandler(
		"{{.DomainLower}}_deleted_handler",
		string({{.DomainLower}}.Event{{.DomainTitle}}Deleted),
		s.Handle{{.DomainTitle}}Deleted,
	)
}
